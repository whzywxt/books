## 1 概述

#### 1.4 互联网地址
互联网上的每个接口必须有一个唯一的 Internet 地址(也称作IP地址)。IP地址长32 bit。

五类不同的互联网地址格式：
```
A类：    0 +  7位网络号 + 24位主机号
B类：   10 + 14位网络号 + 16位主机号
C类：  110 + 21位网络号 +  8位主机号
D类： 1110 + 28位多播组号
E类：11110 + 27位（留待后用）

A类：  0.0.0.0 到 127.255.255.255
B类：128.0.0.0 到 191.255.255.255
C类：192.0.0.0 到 223.255.255.255
D类：224.0.0.0 到 239.255.255.255
E类：240.0.0.0 到 247.255.255.255
```

有三类IP地址：单播地址（目的为单个主机）、广播地址（目的端为给定网络上的所有主机）以及多播地址（目的端为同一组内的所有主机）。

#### 1.5 域名系统
提供IP地址和主机名之间的映射信息。

#### 1.6 封装
当应用程序用TCP传送数据时，数据被送入协议栈中，然后逐个通过每一层直到被当作一串比特流送入网络。
其中每一层对收到的数据都要增加一些首部信息（有时还要增加尾部信息）。

TCP 传给 IP 的数据单元称作 TCP 报文段或 TCP 段（TCP segment）。

IP传给网络接口层的数据单元称作 IP 数据报（IP datagram）。

通过以太网传输的比特流称作帧（Frame）。

#### 1.7 分用
当目的主机收到一个以太网数据帧时，数据就开始从协议栈中由底向上升，同时去掉各层协议加上的报文首部。
每层协议盒都要去检查报文首部中的协议标识，以确定接收数据的上层协议。这个过程称作**分用（Demultiplexing）**。

#### 1.8 客户-服务模型
服务分为两种类型：重复型或并发型。一般来说，TCP 服务器是并发的，而 UDP 服务器是重复的，但也有一些例外。

知名端口号介于 `1~255` 之间。`256~1023` 之间的端口号通常由Unix占用，以提供一些特定的Unix服务（Unix系统才有的，其他操作系统可能不提供的服务）。

#### 1.17 小结
TCP/IP协议族分为四层：链路层、网络层、运输层和应用层，每一层各有不同的责任。
网络层和运输层之间的区别最为关键：网络层（IP）提供点到点的服务，而运输层（TCP和UDP）提供端到端的服务。

一个互联网是网络的网络。构造互联网的共同基石是路由器，它们在IP层把网络连在一起。
第一个字母大写的Internet是指分布在世界各地的大型互联网，其中包括1万多个网络和超过100万台主机。

在一个互联网上，每个接口都用IP地址来标识，域名系统为主机名和IP地址之间提供动态的映射。
端口号用来标识互相通信的应用程序。服务器使用知名端口号，而客户使用临时设定的端口号。

---
## 2 链路层

#### 2.4 SLIP：串行线路IP
全称是 Serial Line IP，它是一种在串行线路上对IP数据报进行封装的简单形式。

#### 2.5 压缩的SLIP
由于串行线路的速率通常较低（19200 b/s 或更低），而且通信经常是交互式的（如 Telnet 和 Rlogin，二者都使用 TCP），
因此在 SLIP 线路上有许多小的 TCP 分组进行交换。为了传送1个字节的数据需要20个字节的IP首部和20个字节的TCP首部，
总数超过40个字节。

CSLIP（压缩SLIP）一般能将上面的40个字节压缩到3或5个字节。能在CSLIP的每一端维持多达 16 个 TCP 连接。

#### 2.6 PPP：点对点协议
1）在串行链路上封装 IP 数据报的方法。

2）建立、配置及测试数据链路的链路控制协议（LCP：Link Control Protocol）。它允许通信双方进行协商，以确定不同的选项。

3）针对不同网络层协议的网络控制协议（NCP：Network Control Protocol）体系

#### 2.7 环回接口
大多数产品都支持环回接口（Loopback Interface），以允许运行在同一台主机上的客户程序和服务器程序通过 TCP/IP 进行通信。
A类网络号127就是为环回接口预留的。大多数系统把 127.0.0.1 分配给这个接口，并命名为 localhost。

一旦传输层检测到目的端地址是环回地址时，应该可以省略部分传输层和所有网络层的逻辑操作。
但是大多数的产品还是照样完成传输层和网络层的所有过程，只是当IP数据报离开网络层时把它返回给自己。

#### 2.8 最大传输单元MTU
以太网和802.3对数据帧的长度有一个限制，其最大值分别是1500和1492字节。链路层的这个特性称作MTU，最大传输单元。不同类型的网络大多数都有一个上限。

如果IP层有一个数据报要传，而且数据的长度比链路层的MTU还大，那么IP层就需要进行分片，把数据报分成若干片，这样每一片都小于 MTU。

#### 2.9 路径MTU
同一个网络上，两台主机互相通信时，该网络的 MTU 是非常重要的。
如果两台主机之间的通信要通过多个网络，那么每个网络的链路层就可能有不同的 MTU。
重要的是两台通信主机路径中的最小 MTU。它被称作路径 MTU。

---
## 3 IP：网际协议
#### 3.1 引言
IP是TCP/IP协议族中最为核心的协议。所有的TCP、UDP、ICMP及IGMP数据都以IP数据报格式传输。

不可靠（unreliable）是它不能保证IP数据报能成功地到达目的地。IP仅提供最好的传输服务。

无连接（connectionless）是IP并不维护任何关于后续数据报的状态信息。每个数据报的处理都是相互独立的。IP数据报可以不按发送顺序接收。
如，连续的数据报（先A后B），每个数据报都是独立地进行路由选择，可能选择不同的线路，因此B可能在A到达之前先到达。

#### 3.2 IP首部
普通IP首部长为20个字节，除非含有选项字段。
| 0 |   | 15 | 16 | 31 |
|---|---|---:|:---|---:|
| 4位版本 | 4位首部长度 | 8位服务类型（TOS）| 16位总长度（字节数）|
| 16位标识 | | |3位标志 | 13位片偏移 |
| 8位生存时间（TTL）| | 8位协议 | 16位首部检验和 |
| 32位源IP地址 |
| 32位目的IP地址 |
| 选项（如果有） |
| 数据 |

#### 3.8 iconfig
ifconfig

环回接口被认为是一个网络接口。它是一个A类地址,没有进行子网划分。

#### 3.9 netstat
`netstat -in` 打印出接口信息 打印出IP地址

#### 3.11 小结
IP路由选择，主机的路由选择：如果目的主机在直接相连的网络上，那么就把数据报直接传给目的主机，否则传给默认路由器。

在进行路由选择决策时，主机和路由器都使用路由表。

三种类型路由表：
- 特定主机型
- 特定网络型
- 默认路由型

优先级：主机路由 > 网络路由 > 默认路由。

IP路由选择是通过逐跳来实现的。数据报在各站的传输过程中目的IP地址始终不变，但是封装和目的链路层地址在每一站都可以变。

A类地址和B类地址一般都要进行子网划分。

---
## 4 ARP：地址解析协议
从逻辑Internet地址到对应的物理硬件地址需要进行翻译，这就是ARP的功能。

ARP 本来是用于广播网络的，有许多主机或路由器连在同一个网络上。

#### 4.3 ARP 告诉缓存
高速缓存存放了最近 Internet 地址到硬件地址之间的映射记录，是**ARP 高效运行的关键**，每一项的生存时间一般为 20 分钟，起始时间从被创建时开始算起。

---
## 5 RARP：逆地址解析协议

RARP 协议是许多**无盘系统**在引导时用来获取IP地址额一个 RARP 请求在网络上进行广播，它在分组中标明发送端的硬件地址，以请求相应 IP 地址的响应。应答通常是单播传送的。

RARP 服务器的实现与系统相关，并不是所有的 TCP/IP 实现都提供 RARP 服务器。

---
## 6 ICMP：Internet控制报文协议

#### 6.2 ICMP 报文类型
对 ICMP 差错报文进行响应时，永远不会生成另一份 ICMP 差错报文（如果没有这个限制规则，会无休止的循环下去）。

#### 6.4 ICMP 时间戳请求与应答
ICMP 时间戳请求允许系统向另一个系统查询当前的时间。返回的建议值是自午夜开始计算的毫秒数，协调的统一时间。这种 ICMP 报文的好处是它提供了毫秒级的分辨率，而利用其它方法从别的主机获取的时间只能提供秒级的分辨率。

---
## 7 Ping 程序
局域网上运行ping程序

返回ICMP回显应答时，要打印序列号和TTL，并计算往返时间（TTL位于IP首部中的生存时间字段）。

ping程序通过做在ICMP报文数据中存放发送请求的时间来计算往返时间。当应答返回时，用当前时间减去存放在ICMP报文中的时间值，即往返时间。
*有时往返时间的计算结果都为 `0ms`，其实是因为程序使用的计时器分辨率低的原因（比如有的系统只能提供10ms级的计时器）。*

从 `tcpdump` 中看，从发送回显请求到收到回显应答，通常第一个往返时间值要比其它的大，这是由于目的端的硬件地址不在ARP高速缓存中。

默认情况下发送的 ICMP 报文有 56 个字节,再加上 20 个字节的IP首部和 8 个字节的ICMP首部，IP数据报的总长度为 84 字节。（可运行 `tcpdump -e` 命令查看以太网数据帧）
```
# ping -s 100 baidu.com
PING baidu.com (220.181.38.148) 100(128) bytes of data.
108 bytes from 220.181.38.148 (220.181.38.148): icmp_seq=1 ttl=52 time=43.1 ms
108 bytes from 220.181.38.148 (220.181.38.148): icmp_seq=2 ttl=52 time=42.4 ms
```

ping程序是对两个TCP/IP系统连通性进行测试的基本工具。它只利用ICMP回显请求和回显应答报文，而不用经过传输层（TCP/UDP）。Ping服务器一般在内核中实现ICMP的功能。

---
## 8 Traceroute 程序
尽管不能保证从源端发往目的端的两份连续的IP数据报具有相同的路由，但大多数情况下是这样的。Traceroute 程序可以让我们看到IP数据从一台主机传到另一台主机所经过的路由。

```
# traceroute baidu.com
traceroute to baidu.com (220.181.38.148), 30 hops max, 60 byte packets
 1  10.4.164.38 (10.4.164.38)  1.983 ms 10.4.168.38 (10.4.168.38)  2.292 ms  2.235 ms
 2  10.4.168.29 (10.4.168.29)  6.172 ms  6.024 ms *
```
第1个无标号行给出了目的主机名和其ip地址，指出 traceroute 程序最大的TTL字段值为 30.

小结

在一个TCP/IP网络中，traceroute程序是不可缺少的工具。其操作很简单：开始时发送一个TTL字段为 1 的UDP数据报，然后将TTL字段每次加 1，以确定路径中的每个路由器。每个路由器在丢弃UDP数据报时都返回一个ICMP超时报文2，而最终目的主机则产生一个ICMP端口不可到达的报文。

## 9 IP选路
选路时IP最重要的功能之一。

需要进行选路的数据报可以由本地主机产生，也可以由其它主机产生。在后一种情况下，主机必须配置成一个路由器，否则通过网络接口接收到的数据报，如果目的地址不是本机就要被丢弃。

路由守护程序（daemon），通常是一个用户进程。一般在引导时启动，在系统运行期间一直存在。

#### 9.2 选路的原理
IP搜索路由表的几个步骤：
1. 搜索匹配的主机地址；
2. 搜索匹配的网络地址；
3. 搜索默认表项（默认表项一般在路由表中被指定为一个网络表项，其网络号为0）。

IP层进行的选路实际上是一种选路机制，而路由守护进程则一般提供选路策略。

`netstat -rn`

五种不同的标志：
U 该路由可以使用。
G 该路由是到一个网关（路由器）。如果没有该标志，说明目的地是直接相连的。
H 该路由是到一个主机，即目的地址是一个完整的主机地址。
D 该路由是由重定向报文创建的。
M 该路由已被重定向报文修改。

---
## 10 动态选路协议
两种基本的选路协议：
- 内部网关协议（IGP）
- 外部网关协议（EGP）

---
## 11 UDP：用户数据报协议
进程的每个输出操作都正好产生一个 UDP 数据报，并组装成一份待发送的 IP 数据报。

UDP不提供可靠性：它把应用程序传给IP层的数据发送出去，但是并不保证它们能到达目的地。

应用程序必须关心IP数据报的长度。如果它超过网络的MTU，那么就要对IP数据报进行分片。如果需要，源端到目的端之间的每个网络都要进行分片，并不只是发送端主机连接第一个网路才这样做。

#### 11.12 UDP服务器设计
1. 客户IP地址及端口号

IP首部包含源端和目的端地址，UDP首部包含了源端和目的端的UDP端口号。当一个应用程序收到UDP数据报时，操作系统必须告诉它是谁发送了这份消息，即源IP地址和端口号。

2. 目的IP地址

3. UDP输入队列

大多数UDP服务器是交互服务器，即单个服务器进程对单个UDP端口上（服务器上的知名端口）的所有客户请求进行处理。

通常程序所使用的每个UDP端口都与一个有限大小的输入队列相联系，即来自不同客户的差不多同时到达的请求将由UDP自动排队。接收到的UDP数据报以其接收顺序交给应用程序。

排队溢出造成内核中的UDP模块丢弃数据报的可能性是存在的，UDP输出队列是FIFO（先进先出），而ARP输入却是LIFO（后进先出）的。

4. 限制本地IP地址
5. 限制远端IP地址
6. 每个端口有多个接收者

当UDP数据报到达的目的IP地址为广播地址或多播地址，而且在目的IP地址和端口号处有多个端点时，就向每个端点传送一份数据报的复制（端点的本地IP地址可以含有星号，它可匹配任何目的IP地址）。

#### 11.13 小结
UDP是一个简单协议。它向用户进程提供的服务位于IP层之上，包括端口号和可选的检验和。

---
## 12 广播和多播
广播和多播仅用于UDP，它们对需将报文同时传往多个接收者的应用来说十分重要。

TCP是一个面向连接的协议，意味着分别运行于两主机内（由IP地址确定）的两进程（由端口号确定）间存在一条连接。

#### 12.4 多播
IP多播提供两类服务：
1. 向多个目的地址传送数据。有许多向多个接收者传送信息的应用：例如交互式会议系统和向多个接收者分发邮件或新闻。如果不采用多播，目前这些应用大多采用TCP来完成（向每个目的地址传送一个单独的数据复制）。即使使用多播，某些应用可能继续采用TCP来保证它的可靠性。
2. 客户对服务器的请求。例如，无盘工作站需要确定启动引导服务器。目前，这项服务是通过广播来提供的，但是使用多播可降低不提供这项服务主机的负担。

#### 12.5 小结
广播是将数据报发送到网络中的所有主机（通常是本地相连的网络），而多播是将数据报发送到网络的一个主机组。两个概念的基本点在于当收到送往上一个协议栈的数据帧时采用不同类型的过滤。每个协议层均可以因为不同的理由丢弃数据报。

广播地址：
- 受限的广播（通常只在系统初始启动时才会用到）
- 指向网络的广播
- **指向子网的广播（常用）**
- 指向所有子网的广播

D类IP地址被称为多播组地址。通过将其低位32bit映射到相应以太网地址中便可以实现多播组地址到以太网地址的转换。由于地址映射不是唯一的，因此需要其他的协议实现额外的数据报过滤。

---
## 13 IGMP：Internet组管理协议
多播是一种将报文发往多个接收者的通信方式。在许多应用中，它比广播更好，因为多播降低了不参与通信的主机的负担。简单的主机成员报告协议（IGMP）是多播的基本模块。

广播通常局限在单个局域网中，对目前许多使用广播的应用来说，可采用多播来替代广播。

---
## 14 DNS：域名系统
域名系统（DNS）是一种用于TCP/IP应用程序的分布式数据库，它提供主机名字和IP地址之间的转换及有关电子邮件的选路信息。

---
## 15 TFTP：简单文件传送协议
TFTP是一个简单的协议，适合于只读存储器，仅用于无盘系统进行系统引导。它只使用几种报文格式，是一种停止等待协议。
为了允许多个客户端同时进行系统引导，TFTP服务器必须提供一定形式的并发。因为UDP在一个客户与一个服务器之间并不提供唯一连接（TCP也一样），TFTP服务器通过为每个客户提供一个新的UDP端口来提供并发。

---
## 16 BOOTP：引导程序协议
BOOTP使用UDP，且通常需与TFTP协同工作。

---
## 17 TCP：传输控制协议
尽管TCP和UDP都使用相同的网络层（IP），TCP却向应用层提供与UDP完全不同的服务。TCP提供一种面向连接的、可靠的字节流服务。

面向连接意味着两个使用TCP的应用（通常是一个客户和一个服务器）在彼此交换数据之前必须先简历一个TCP连接。

在一个TCP连接中，仅有两方进行彼此通信。

TCP通过下列方式来提供可靠性：
- 应用数据被分隔成TCP认为最适合发送的数据块。
- 当TCP发出一个段后，它启动一个定时器，等目的端确认收到这个报文段。如果不能及时收到一个确认，将重发这个报文段。
- 当TCP收到发自TCP连接另一端的数据，它将发送一个确认。这个确认不是立即发送，通常将推迟几分之一秒。
- TCP将保持它首部和数据的检验和。端到端的检验和，目的是检测数据在传输过程中的任何变化。如果收到段的检验和有差错，TCP将丢弃这个报文段和不确认收到此报文段（希望发端超时并重发）。
- 既然TCP报文段作为IP数据报来传输，而IP数据报的到达可能会失序，因此TCP报文段的到达也可能会失序。如果有必要，TCP将对收到的数据进行重新排列，将收到的数据以正确的顺序交给应用层。
- 既然IP数据报会发生重复，TCP的接收端必须丢弃重复的数据。
- TCP还能提供流量控制。TCP连接的每一方都有固定大小的缓冲空间。TCP的接收端只允许另一端发送接收端缓冲区区所能接纳的数据。防止较快主机致使较慢主机的缓冲区溢出。

在TCP首部中有6个标志比特，它们中多个可同时被设置为1。
- `URG` 紧急指针（urgent pointer）有效
- `ACK` 确认序号有效
- `PSH` 接收方应该尽快将这个报文段交给应用层
- `RST` 重建连接
- `SYN` 同步序号用来发起一个连接
- `FIN` 发端完成发送任务

TCP将用户数据打包构成报文段；它发送数据后启动一个定时器；另一端对收到的数据进行确认，对失序的数据重新排序，丢弃重复数据；TCP提供端到端的流量控制，并计算和验证一个强制性的端到端检验和。

许多流行应用程序如Telnet、Rlogin、FTP和SMTP都使用TCP。

---
## 18 TCP连接的建立和终止

同时打开 和 同时关闭

大多数的TCP服务器进程是并发的。

远端地址显示为 `*.*`，表示还不知道远端IP地址和端口号
- `ESTABLISHED`
- `LISTEN`

限定的本地IP地址，当服务器不能任选其本地IP地址而必须使用特定的IP地址

限定的远端IP地址，服务器必须不指明远端插口，而是等待连接的到来，然后检查客户端的IP地址和端口号。

呼入连接请求队列

伯克利的TCP实现中采用以下规则：
1）正等待连接请求的一端有一个固定长度的连接队列，该队列中的连接已被TCP接受（即三次握手已经完成），但还没有被应用层所接受。
*注意区分TCP接受一个连接是将其放入这个队列，而应用层接受连接是将其从该队列中移出。*

2）应用层将指明该队列的最大长度，这个值通常称为积压值（backlog）。它的取值范围是 `0 ~ 5` 之间的整数，包括0和5（大多数应用程序将这个值说明为5）。

3）当一个连接请求（即SYN）到达时，TCP使用一个算法，根据当前队列中的连接数来确定是否接收这个连接。
*注意，积压值说明的是TCP监听的端点已被TCP接受而等待应用层接受的最大链接数。这个积压值对系统所允许的最大链接数，或者并发服务器所能并发处理的客户数，并无影响。*