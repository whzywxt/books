## 第15章 位操作

### 15.1 二进制数、位和字节
略

### 15.2 其他进制数
略

### 15.3 C按位运算符
1.二进制反码或按位取反：~

一元运算符~把1变为0，把0变为1 。

用法：
- 关闭位（清空位），在不影响其他位的情况关闭指定的位。
假设要关闭变量 flags 中的 1 号位。同样，MASK只有 1 号位位 1（即，打开）。
```
flags = flags & ~MASK;
flags &= ~MASK; // 简化形式
```

2.按位与：& **任何位与 1 组合都得本身。任何位与0组合都得0 。**

通过逐位比较两个运算对象，生成一个新值。只有两个位都为真时，结果才为真。

用法：
- 掩码，指的是一些设置为开（1）或关（0）的位组合。
```
flags = flags & MASK;
flags &= MASK; // 简化形式
```

3.按位或：|

两个运算对象中相应的一个位为真或两个位都为真，那么结果为真。

用法：
- 打开位（设置位），打开一个值中的特定位，同事保持其他位不变。
```
flags = flags | MASK;
flags |= MASK; // 简化形式
```
- 检查某位的值，flags中的 1 号位是否被设置为 1
```
if ((flags & MASK) == MASK) {
    // ...
}
```

4.按位异或：^

参与运算的两个值，如果两个相应bit位相同，则结果为0，否则为1 。
- 0 异或任何数 = 任何数
- 1 异或任何数

用法：
- 切换位，指打开已关闭的位，或关闭已打开的位。

移位运算符
1.左移：`<<`

将其左侧运算对象每一位的值**向左移动**其右侧运算对象指定的位数。左侧运算对象移出左末端位的值丢失，用0填充空出的位置。
```
int stonk = 1;
int onkoo;
onkoo = stonk << 2; /*把4赋给onkoo*/
stonk <<= 2; /*把stonk的值值改为4*/
```

2.右移：`>>`

将其左侧运算对象每一位的值**向右移动**其右侧运算对象指定的位数。左侧运算对象移出*右末端位*的值丢。
**对于无符号类型，用 0 填充空出的位置；对于有符号类型，其结果取决于机器。**
空出的位置可用 0 填充，或者用符号位（即，最左端的位）的副本填充：
```
int sweet = 16;
int ooosw;
ooosw = sweet >> 3; // ooosw值为2，sweet值仍为16
sweet >>= 3;        // sweet值为2
```

### 15.4 位字段
略

### 15.5 对齐特性
C11 的对齐特性比用位填充字节更自然，还代表了C在处理硬件相关问题上的能力。

在这种上下文中，对齐指的是如何安排对象在内存中的位置。
例如，为了效率最大化，系统可能要把一个 double 类型的值存储在 4 字节内存地址上，但却允许把 char 储存在任意地址。

有些情况又受益于对齐控制。例如，把数据从一个硬件位置转移到另一个位置，或者调用指令同时操作多个数据项。

_Alignof 运算符给出一个类型的对齐要求，再关键字 _Alignof 后面的圆括号中写上类型名即可：

`size_t d_align = _Alignof(float)`

假设 d_align的值是4，意思是float类型对象的对齐要求是4 。也就是说，4 是储存该类型值相邻地址的字节数。一般而言，对齐值都应该是 2 的非负整数次幂。较大的对齐值被称为 stricter 或 stronger，较小的对齐值被称为 weaker 。

可以使用 _Alignas 说明符指定一个变量或类型的对齐值。但是，不应该要求该值小于基本对齐值。
例如，如果 float 类型的对齐要求是 4，不要请求其对齐值是 1 或 2 。该说明符用作声明的一部分，说明符后面的圆括号内包含对齐值或类型：

`_Alignas(double) char c1;`

`_Alignas(8) char c2;`

`unsigned char _Alignas(long double) c_arr[sizeof(long double)]`

在程序中包含 `stdalign.h` 头文件后，就可以把 `alignas` 和 `alignof` 分别作为
`_Alignas` 和 `_Alignof` 的别名。这样做可以与C++关键字匹配。

C11在stdlib.h库还添加了一个新的内存分配函数，用于对齐动态分配的
内存。该函数的原型如下：

`void *aligned_alloc(size_t alignment, size_t size);`

第1个参数代表指定的对齐，第二个参数是所需的字节数，其值应该是第1个参数的倍数。与其他内存分配函数一样，要使用`free()`函数释放之前分配的内存。

### 15.6 关键概念
C区别于许多高级语言的特性之一是访问整数中单独位的能力。该特性通常是与硬件设备和操作系统交互的关键。

C有两种访问位的方法。一种方法是通过按位运算符，另一种方法是在结构中创建位字段。

C11新增了检查内存对齐要求的功能，而且可以指定比基本对齐值更大的对齐值。

通常（但不总是），使用这些特性的程序仅限于特定的硬件平台或操作系统，而且设计为不可移植。

### 15.7 本章小结
C不允许以二进制形式书写数字，但是它识别与二进制相关的八进制和十六禁止记数法。正如每个二进制数字表示1位一样，每个八进制位代表3位，每个十六进制位代表4位。
这种关系使得二进制转为八进制或十六进制较为简单。
