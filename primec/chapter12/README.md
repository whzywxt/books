## 第12章 存储类别、链接和内存管理

### 12.1 存储类别

#### 作用域

#### 链接
C 变量有 3 种链接属性：外部链接、内部链接或无链接。

具有块作用域、函数作用域或函数原型作用域的变量都是无链接变量。这些变量属于定义它们的块、函数或原型私有。

具有文件作用域的变量可以是外部链接或内部链接。外部链接变量可以在多文件程序中使用，内部链接变量只能在一个翻译单元中使用。

内部链接的文件作用域，称为文件作用域；如 `static int giants = 5;`
外部链接的文件作用域，称为全局作用域。如 `int giants = 5;`

#### 存储期
作用域和链接描述了标识符的可见性。
存储期描述了通过这些标识符访问的对象的生存期。
C 对象有 4 种存储期：静态存储期、线程存储期、自动存储期、动态分配存储期。
- 静态储存期，对象在程序执行期间一直存在。
- 线程存储期，用于并发程序设计，程序执行可被分为多个线程。具有线程存储期的对象，从被声明时到线程结束时一直存在。以关键字 `_Thread_local` 声明一个对象时，每个线程都获得该变量的私有备份。
- 自动存储期，程序进入定义这些变量的块时，为这些变量分配内存；当退出这个块时，释放为变量分配的内存。
- 动态分配存储，变长数组，它们的存储期从声明处到块的末尾，而不是从块的开始处。

C 使用作用域、链接和存储期为变量定义了多种存储方案。

|存储类别|存储期|作用域|链接|声明方式|
|-------|-----|-----|---|------|
|自动|自动|块|无|块内|
|寄存器|自动|块|无|块内，使用关键字 register|
|静态外部链接|静态|文件|外部|所有函数外|
|静态内部链接|静态|文件|内部|所有函数外，使用关键字 static|
|静态无链接|静态|块|无|块内，使用关键字 static|

###### 自动变量
- 程序在进入该变量声明所在的块时变量存在，程序在退出该块时变量消失。原该变量占用的内存位置现在可做他用。
- 自动变量不会初始化，除非显示初始化它。

###### 寄存器变量
- 幸运的话，寄存器变量储存在CPU的寄存器中。
- 声明变量为 register 类别与直接命令相比更像是一种请求。编译器必须根据寄存器或最快可用内存的数量衡量你的请求，或者直接忽略你的请求，所以最终寄存器变量不一定存储的CPU的寄存器种。
- 可声明为 register 的数据类型有限。

###### 块作用域的静态变量
- 静态是该变量在内存中原地不动，值可以改变。
- 计算机在多次函数调用之间会记录它们的值。
- 只在编译时被初始化一次。
- 不能在函数的形参中使用 static。

###### 外部链接的静态变量
- 文件作用域、外部链接和静态存储期。
- 有时称为外部存储类别，属于该类别的变量称为外部变量。
- 为指出该函数使用了外部变量，可以在函数中用关键字 extern 再次申明。

###### 内部链接的静态变量
- 文件作用域、内部链接和静态存储期。

###### 存储类别说明符
- 关键字 static 和 extern 的含义取决于上下文
- 说明符 auto、register、static、extern、_Thread_local、typedef
- _Thread_local 可以和 static 或 extern 一起使用

###### 存储类别的选择
- 默认类别就是自动存储类别，其他存储类别也很有用，但需要考虑是否必要使用。
- 经验表明，随意使用外部存储类别的变量导致的后果远远超过了它所带来的便利。
- const 数据，初始化后就不会被修改，不用担心被意外修改。

保护性程序设计的黄金法则：“按需知道”原则。尽量在函数内部解决该函数的任务，只共享那些需要共享的变量。

### 随机数函数和静态变量
“种子”

### 分配内存
`malloc()` 与 `free()` 配套使用，free **不能释放**通过其他方式分配的内存。free 参数应该是一个指针。

静态数据在程序载入内存时分配，而自动数据在程序执行块时分配，并在离开该块时销毁。

创建数组的3种方法
- 用常量表达式表示数组的纬度，用数组名访问数组的元素。可以用静态内存或自动内存创建这种数组。
- 变长数组（C99新增特性）时，用变量表达式表示数组的维度，用数组名访问数组的元素。只能在自动内存中创建。
- 声明一个指针，调用malloc，将其返回值赋给指针，使用指针访问数组的元素。该指针可以式静态的或动态的。

